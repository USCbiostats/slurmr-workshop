---
output:
    html_document:
        toc: true
        toc_float: true
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
```

# Beginning with USC HPC cluster

## Overview of HPC at USC

<figure>

<img src="figs/CARC-cyberinfrastructure.png" alt="Cyberinfrastructure overview" style="width:80%;"/>

<figcaption>

Cyberinfrastructure overview (source: <https://carc.usc.edu/user-information/system-information>)

</figcaption>

</figure>

## Loging in

Log-in using ssh. In the case of Windows users, download the [Putty](https://www.chiark.greenend.org.uk/~sgtatham/putty/) client. You have two options, the [discovery](https://carc.usc.edu/user-information/user-guides/high-performance-computing/getting-started-discovery) or [endeavour](https://carc.usc.edu/user-information/user-guides/high-performance-computing/getting-started-endeavour) clusters.

To login, you will need to use your USC Net ID. If your USC email is `flasname@usc.edu`, your USC Net ID is `flastname`. Then:

``` {.bash}
ssh flastname@discovery.usc.edu
```

if you want to use the discovery cluster (available to all USC members), or

``` {.bash}
ssh flastname@endeavour.usc.edu
```

if you want to use the endeavour cluster (using private condos).

## Data management

IMHO, these are the most important things to know about data management at USC's HPC:

1. Do your data transfer using the transfer nodes (it is faster).

2. Never use your home directory as a storage space (use your project's allotted
  space instead).

3. Use the scratch filesystem for temp data only, i.e., never save important
  files in scratch.
  
4. Finally, besides of **Secure copy protocol (scp)**, if you are like me, try setting up a GUI client for moving your data (see [this](https://carc.usc.edu/user-information/user-guides/data-management/transferring-files-gui)).



## Using R on the HPC

1.  The HPC has several pre-installed pieces of software. R is one of those.

2.  It has multiple versions of R installed. Use your favorite one by running

    ``` {.bash}
    module load usc r/[version number]
    ```

    Where `[version number]` can be 3.5.6 and up to 4.0.3 (the latest update). The `usc` module automatically loads gcc/8.3.0, openblas/0.3.8, openmpi/4.0.2, and pmix/3.1.3.

3.  It is never a good idea to use your home directory to install R packages, that's why you should try using a [symbolic link instead](), like this

    ``` {.bash}
    cd ~
    mkdir -p /path/to/a/project/with/lots/of/space/R
    ln -s /path/to/a/project/with/lots/of/space/R R
    ```

    This way, whenever you install your R packages, R will default to that location

4.  You can run interactive sessions on HPC, but this recommended to be done using the `salloc` function in Slurm, in other words, NEVER EVER USE R (OR ANY SOFTWARE) TO DO DATA ANALYSIS IN THE HEAD NODES! The options passed to salloc are the same options that can be passed to `sbatch` (see the next section.) For example, if need to do some analyses in the `thomas` partition (which is private and I have access to), I would type something like

    ``` {.bash}
    salloc --account=lc_pdt --partition=thomas --time=02:00:00 --mem-per-cpu=2G
    ```

    This would put me in a single node allocating 2 gigs of memory for a maximum of 2 hours.

