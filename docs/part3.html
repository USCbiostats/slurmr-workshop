<!DOCTYPE html>

<html>

<head>

<meta charset="utf-8" />
<meta name="generator" content="pandoc" />
<meta http-equiv="X-UA-Compatible" content="IE=EDGE" />




<title>Misc</title>

<script src="site_libs/header-attrs-2.6/header-attrs.js"></script>
<script src="site_libs/jquery-1.11.3/jquery.min.js"></script>
<meta name="viewport" content="width=device-width, initial-scale=1" />
<link href="site_libs/bootstrap-3.3.5/css/cerulean.min.css" rel="stylesheet" />
<script src="site_libs/bootstrap-3.3.5/js/bootstrap.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/html5shiv.min.js"></script>
<script src="site_libs/bootstrap-3.3.5/shim/respond.min.js"></script>
<script src="site_libs/navigation-1.1/tabsets.js"></script>
<link href="site_libs/font-awesome-5.1.0/css/all.css" rel="stylesheet" />
<link href="site_libs/font-awesome-5.1.0/css/v4-shims.css" rel="stylesheet" />

<style type="text/css">
  code{white-space: pre-wrap;}
  span.smallcaps{font-variant: small-caps;}
  span.underline{text-decoration: underline;}
  div.column{display: inline-block; vertical-align: top; width: 50%;}
  div.hanging-indent{margin-left: 1.5em; text-indent: -1.5em;}
  ul.task-list{list-style: none;}
    </style>


<style type="text/css">code{white-space: pre;}</style>
<style type="text/css" data-origin="pandoc">
pre > code.sourceCode { white-space: pre; position: relative; }
pre > code.sourceCode > span { display: inline-block; line-height: 1.25; }
pre > code.sourceCode > span:empty { height: 1.2em; }
code.sourceCode > span { color: inherit; text-decoration: inherit; }
div.sourceCode { margin: 1em 0; }
pre.sourceCode { margin: 0; }
@media screen {
div.sourceCode { overflow: auto; }
}
@media print {
pre > code.sourceCode { white-space: pre-wrap; }
pre > code.sourceCode > span { text-indent: -5em; padding-left: 5em; }
}
pre.numberSource code
  { counter-reset: source-line 0; }
pre.numberSource code > span
  { position: relative; left: -4em; counter-increment: source-line; }
pre.numberSource code > span > a:first-child::before
  { content: counter(source-line);
    position: relative; left: -1em; text-align: right; vertical-align: baseline;
    border: none; display: inline-block;
    -webkit-touch-callout: none; -webkit-user-select: none;
    -khtml-user-select: none; -moz-user-select: none;
    -ms-user-select: none; user-select: none;
    padding: 0 4px; width: 4em;
    background-color: #2a211c;
    color: #bdae9d;
  }
pre.numberSource { margin-left: 3em; border-left: 1px solid #bdae9d;  padding-left: 4px; }
div.sourceCode
  { color: #bdae9d; background-color: #2a211c; }
@media screen {
pre > code.sourceCode > span > a:first-child::before { text-decoration: underline; }
}
code span.al { color: #ffff00; } /* Alert */
code span.an { color: #0066ff; font-weight: bold; font-style: italic; } /* Annotation */
code span.at { } /* Attribute */
code span.bn { color: #44aa43; } /* BaseN */
code span.bu { } /* BuiltIn */
code span.cf { color: #43a8ed; font-weight: bold; } /* ControlFlow */
code span.ch { color: #049b0a; } /* Char */
code span.cn { } /* Constant */
code span.co { color: #0066ff; font-weight: bold; font-style: italic; } /* Comment */
code span.do { color: #0066ff; font-style: italic; } /* Documentation */
code span.dt { text-decoration: underline; } /* DataType */
code span.dv { color: #44aa43; } /* DecVal */
code span.er { color: #ffff00; font-weight: bold; } /* Error */
code span.ex { } /* Extension */
code span.fl { color: #44aa43; } /* Float */
code span.fu { color: #ff9358; font-weight: bold; } /* Function */
code span.im { } /* Import */
code span.in { color: #0066ff; font-weight: bold; font-style: italic; } /* Information */
code span.kw { color: #43a8ed; font-weight: bold; } /* Keyword */
code span.op { } /* Operator */
code span.pp { font-weight: bold; } /* Preprocessor */
code span.sc { color: #049b0a; } /* SpecialChar */
code span.ss { color: #049b0a; } /* SpecialString */
code span.st { color: #049b0a; } /* String */
code span.va { } /* Variable */
code span.vs { color: #049b0a; } /* VerbatimString */
code span.wa { color: #ffff00; font-weight: bold; } /* Warning */

</style>
<script>
// apply pandoc div.sourceCode style to pre.sourceCode instead
(function() {
  var sheets = document.styleSheets;
  for (var i = 0; i < sheets.length; i++) {
    if (sheets[i].ownerNode.dataset["origin"] !== "pandoc") continue;
    try { var rules = sheets[i].cssRules; } catch (e) { continue; }
    for (var j = 0; j < rules.length; j++) {
      var rule = rules[j];
      // check if there is a div.sourceCode rule
      if (rule.type !== rule.STYLE_RULE || rule.selectorText !== "div.sourceCode") continue;
      var style = rule.style.cssText;
      // check if color or background-color is set
      if (rule.style.color === '' && rule.style.backgroundColor === '') continue;
      // replace div.sourceCode by a pre.sourceCode rule
      sheets[i].deleteRule(j);
      sheets[i].insertRule('pre.sourceCode{' + style + '}', j);
    }
  }
})();
</script>
<style type="text/css">
  pre:not([class]) {
    background-color: white;
  }
</style>


<style type="text/css">
h1 {
  font-size: 34px;
}
h1.title {
  font-size: 38px;
}
h2 {
  font-size: 30px;
}
h3 {
  font-size: 24px;
}
h4 {
  font-size: 18px;
}
h5 {
  font-size: 16px;
}
h6 {
  font-size: 12px;
}
.table th:not([align]) {
  text-align: left;
}
</style>





<style type = "text/css">
.main-container {
  max-width: 940px;
  margin-left: auto;
  margin-right: auto;
}
code {
  color: inherit;
  background-color: rgba(0, 0, 0, 0.04);
}
img {
  max-width:100%;
}
.tabbed-pane {
  padding-top: 12px;
}
.html-widget {
  margin-bottom: 20px;
}
button.code-folding-btn:focus {
  outline: none;
}
summary {
  display: list-item;
}
</style>


<style type="text/css">
/* padding for bootstrap navbar */
body {
  padding-top: 51px;
  padding-bottom: 40px;
}
/* offset scroll position for anchor links (for fixed navbar)  */
.section h1 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h2 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h3 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h4 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h5 {
  padding-top: 56px;
  margin-top: -56px;
}
.section h6 {
  padding-top: 56px;
  margin-top: -56px;
}
.dropdown-submenu {
  position: relative;
}
.dropdown-submenu>.dropdown-menu {
  top: 0;
  left: 100%;
  margin-top: -6px;
  margin-left: -1px;
  border-radius: 0 6px 6px 6px;
}
.dropdown-submenu:hover>.dropdown-menu {
  display: block;
}
.dropdown-submenu>a:after {
  display: block;
  content: " ";
  float: right;
  width: 0;
  height: 0;
  border-color: transparent;
  border-style: solid;
  border-width: 5px 0 5px 5px;
  border-left-color: #cccccc;
  margin-top: 5px;
  margin-right: -10px;
}
.dropdown-submenu:hover>a:after {
  border-left-color: #ffffff;
}
.dropdown-submenu.pull-left {
  float: none;
}
.dropdown-submenu.pull-left>.dropdown-menu {
  left: -100%;
  margin-left: 10px;
  border-radius: 6px 0 6px 6px;
}
</style>

<script>
// manage active state of menu based on current page
$(document).ready(function () {
  // active menu anchor
  href = window.location.pathname
  href = href.substr(href.lastIndexOf('/') + 1)
  if (href === "")
    href = "index.html";
  var menuAnchor = $('a[href="' + href + '"]');

  // mark it active
  menuAnchor.parent().addClass('active');

  // if it's got a parent navbar menu mark it active as well
  menuAnchor.closest('li.dropdown').addClass('active');
});
</script>

<!-- tabsets -->

<style type="text/css">
.tabset-dropdown > .nav-tabs {
  display: inline-table;
  max-height: 500px;
  min-height: 44px;
  overflow-y: auto;
  background: white;
  border: 1px solid #ddd;
  border-radius: 4px;
}

.tabset-dropdown > .nav-tabs > li.active:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li.active:before {
  content: "&#xe258;";
  border: none;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open:before {
  content: "";
  font-family: 'Glyphicons Halflings';
  display: inline-block;
  padding: 10px;
  border-right: 1px solid #ddd;
}

.tabset-dropdown > .nav-tabs > li.active {
  display: block;
}

.tabset-dropdown > .nav-tabs > li > a,
.tabset-dropdown > .nav-tabs > li > a:focus,
.tabset-dropdown > .nav-tabs > li > a:hover {
  border: none;
  display: inline-block;
  border-radius: 4px;
  background-color: transparent;
}

.tabset-dropdown > .nav-tabs.nav-tabs-open > li {
  display: block;
  float: none;
}

.tabset-dropdown > .nav-tabs > li {
  display: none;
}
</style>

<!-- code folding -->




</head>

<body>


<div class="container-fluid main-container">



<div class="navbar navbar-default  navbar-fixed-top" role="navigation">
  <div class="container">
    <div class="navbar-header">
      <!-- NOTE: add "navbar-inverse" class for an alternate navbar background -->
      <button type="button" class="navbar-toggle collapsed" data-toggle="collapse" data-target="#navbar">
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
        <span class="icon-bar"></span>
      </button>
      <a class="navbar-brand" href="index.html">HPC with slurmR</a>
    </div>
    <div id="navbar" class="navbar-collapse collapse">
      <ul class="nav navbar-nav">
        <li><a href="index.html">Home</a></li>
        <li><a href="part1.html">Part 1</a></li>
        <li><a href="part2.html">Part 2</a></li>
        <li><a href="part3.html">Misc</a></li>
      </ul>
      <ul class="nav navbar-nav navbar-right">
        <li><a href="https://image.usc.edu" target="_blank"><img src="https://raw.githubusercontent.com/USCbiostats/badges/master/tommy-image-badge.svg"></a></li>
        <li><a href="https://github.com/USCbiostats/slurmr-workshop"><span class="fab fa-github fa-lg"></span></a></li>
      </ul>
    </div><!--/.nav-collapse -->
  </div><!--/.container -->
</div><!--/.navbar -->

<div class="fluid-row" id="header">



<h1 class="title toc-ignore">Misc</h1>

</div>

<div id="TOC">
<ul>
<li><a href="#general-resources">General resources</a></li>
<li><a href="#data-pointers">Data Pointers</a></li>
<li><a href="#the-slurm-options-they-forgot-to-tell-you-about">The Slurm options they forgot to tell you about…</a></li>
<li><a href="#good-practices-recomendations">Good practices (recomendations)</a></li>
<li><a href="#running-r-interactively">Running R interactively</a></li>
<li><a href="#nonos-when-using-r">NoNos when using R</a></li>
</ul>
</div>

<div id="general-resources" class="section level2">
<h2>General resources</h2>
<p>The Center for Advanced Research Computing (formerly HPCC) has tons of resources online. Here are a couple of useful links:</p>
<ul>
<li><p><strong>Center for Advanced Research Computing Website</strong> <a href="https://carc.usc.edu" class="uri">https://carc.usc.edu</a></p></li>
<li><p><strong>User forum (very useful!)</strong> <a href="https://hpc-discourse.usc.edu/categories" class="uri">https://hpc-discourse.usc.edu/categories</a></p></li>
<li><p><strong>Monitor your account</strong> <a href="https://hpcaccount.usc.edu/" class="uri">https://hpcaccount.usc.edu/</a></p></li>
<li><p><strong>Slurm Jobs Templates</strong> <a href="https://carc.usc.edu/user-information/user-guides/high-performance-computing/slurm-templates" class="uri">https://carc.usc.edu/user-information/user-guides/high-performance-computing/slurm-templates</a></p></li>
<li><p><strong>Using R</strong> <a href="https://carc.usc.edu/user-information/user-guides/software-and-programming/r" class="uri">https://carc.usc.edu/user-information/user-guides/software-and-programming/r</a></p></li>
</ul>
</div>
<div id="data-pointers" class="section level2">
<h2>Data Pointers</h2>
<p>IMHO, these are the most important things to know about data management at USC’s HPC:</p>
<ol style="list-style-type: decimal">
<li><p>Do your data transfer using the transfer nodes (it is faster).</p></li>
<li><p>Never use your home directory as a storage space (use your project’s allotted space instead).</p></li>
<li><p>Use the scratch filesystem for temp data only, i.e., never save important files in scratch.</p></li>
<li><p>Finally, besides of <strong>Secure copy protocol (scp)</strong>, if you are like me, try setting up a GUI client for moving your data (see <a href="https://carc.usc.edu/user-information/user-guides/data-management/transferring-files-gui">this</a>).</p></li>
</ol>
</div>
<div id="the-slurm-options-they-forgot-to-tell-you-about" class="section level2">
<h2>The Slurm options they forgot to tell you about…</h2>
<p>First of all, you have to be aware that the only thing Slurm does is allocate resources. If your application uses parallel computing or not, that’s another story.</p>
<p>Here some options that you need to be aware of:</p>
<ul>
<li><p><code>ntasks</code> (default 1) This tells Slurm how many processes you will have running. Notice that processes need not to be in the same node (so Slurm may reserve space in multiple nodes)</p></li>
<li><p><code>cpus-per-task</code> (defatult 1) This is how many CPUs each task will be using. This is what you need to use if you are using OpenMP (or a package that uses that), or anything you need to keep within the same node.</p></li>
<li><p><code>nodes</code> the number of nodes you want to use in your job. This is useful mostly if you care about the maximum (I would say) number of nodes you want your job to work. So, for example, if you want to use 8 cores for a single task and force it to be in the same node, you would add the option <code>--nodes=1/1</code>.</p></li>
<li><p><code>mem-per-cpu</code> (default 1GB) This is the MINIMUM amount of memory you want Slurm to allocate for the task. Not a hard barrier, so your process can go above that.</p></li>
<li><p><code>time</code> (default 30min) This is a hard limit as well, so if you job takes more than the specified time, Slurm will kill it.</p></li>
<li><p><code>partition</code> (default "“) and <code>account</code> (default”") these two options go along together, this tells Slurm what resources to use. Besides of the private resources we have the following:</p>
<ul>
<li><p><strong>quick partition</strong>: Any job that is small enough (in terms of time and memory) will go this way. This is usually the default if you don’t specify any memory or time options.</p></li>
<li><p><strong>main partition</strong>: Jobs that require more resources will go in this line.</p></li>
<li><p><strong>scavenge partition</strong>: If you need a massive number resources, and have a job that shouldn’t, in principle, take too long to finalize (less than a couple of hours), and <strong>you are OK with someone killing it</strong>, then this queue is for you. The Scavenge partition uses all the idle resources of the private partitions, so if any of the owners requests the resources, Slurm will cancel your job, i.e. you have no priority (see <a href="https://hpcc.usc.edu/support/documentation/scavenge/" target="_blank">more</a>).</p></li>
<li><p><strong>largemem partition</strong>: If you need lots of memory, we have 4 1TB nodes for that.</p></li>
</ul>
<p>More information about the partitions <a href="https://hpcc.usc.edu/support/infrastructure/node-allocation/" target="_blank">here</a></p></li>
</ul>
</div>
<div id="good-practices-recomendations" class="section level2">
<h2>Good practices (recomendations)</h2>
<p>This is what you should use as a minimum:</p>
<pre><code>#SBATCH --output=simulation.out
#SBATCH --job-name=simulation
#SBATCH --time=04:00:00
#SBATCH --mail-user=[you]@usc.edu
#SBATCH --mail-type=END,FAIL</code></pre>
<ul>
<li><p><code>output</code> is the name of the logfile to which Slurm will write.</p></li>
<li><p><code>job-name</code> is that, the name of the job. You can use this to either kill or at least be able to identify what is what you are running when you use <code>myqueue</code></p></li>
<li><p><code>time</code> Try always to set a time estimate (plus a little more) for your job.</p></li>
<li><p><code>mail-user</code>, <code>mail-type</code> so Slurm notifies you when things happen</p></li>
</ul>
<p>Also, in your R code</p>
<ul>
<li>Any I/O should be done to either Scratch (<code>/scratch/[your usc net id]</code>) or Tmp <code>Sys.getenv("TMPDIR")</code>.</li>
</ul>
</div>
<div id="running-r-interactively" class="section level2">
<h2>Running R interactively</h2>
<ol style="list-style-type: decimal">
<li><p>The HPC has several pre-installed pieces of software. R is one of those.</p></li>
<li><p>To access the pre-installed software, we use the <a href="https://lmod.readthedocs.io/en/latest/"><strong>Lmod module system</strong></a> (more information <a href="https://carc.usc.edu/user-information/user-guides/software-and-programming/lmod"><strong>here</strong></a>)</p></li>
<li><p>It has multiple versions of R installed. Use your favorite one by running</p>
<div class="sourceCode" id="cb2"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb2-1"><a href="#cb2-1" aria-hidden="true" tabindex="-1"></a><span class="ex">module</span> load usc r/[version number]</span></code></pre></div>
<p>Where <code>[version number]</code> can be 3.5.6 and up to 4.0.3 (the latest update). The <code>usc</code> module automatically loads gcc/8.3.0, openblas/0.3.8, openmpi/4.0.2, and pmix/3.1.3.</p></li>
<li><p>It is never a good idea to use your home directory to install R packages, that’s why you should try using a <a href="https://en.wikipedia.org/wiki/Symbolic_link"><strong>symbolic link instead</strong></a>, like this</p>
<div class="sourceCode" id="cb3"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb3-1"><a href="#cb3-1" aria-hidden="true" tabindex="-1"></a><span class="bu">cd</span> ~</span>
<span id="cb3-2"><a href="#cb3-2" aria-hidden="true" tabindex="-1"></a><span class="fu">mkdir</span> -p /path/to/a/project/with/lots/of/space/R</span>
<span id="cb3-3"><a href="#cb3-3" aria-hidden="true" tabindex="-1"></a><span class="fu">ln</span> -s /path/to/a/project/with/lots/of/space/R R</span></code></pre></div>
<p>This way, whenever you install your R packages, R will default to that location</p></li>
<li><p>You can run interactive sessions on HPC, but this recommended to be done using the <code>salloc</code> function in Slurm, in other words, NEVER EVER USE R (OR ANY SOFTWARE) TO DO DATA ANALYSIS IN THE HEAD NODES! The options passed to salloc are the same options that can be passed to <code>sbatch</code> (see the next section.) For example, if need to do some analyses in the <code>thomas</code> partition (which is private and I have access to), I would type something like</p>
<div class="sourceCode" id="cb4"><pre class="sourceCode bash"><code class="sourceCode bash"><span id="cb4-1"><a href="#cb4-1" aria-hidden="true" tabindex="-1"></a><span class="ex">salloc</span> --account=lc_pdt --partition=thomas --time=02:00:00 --mem-per-cpu=2G</span></code></pre></div>
<p>This would put me in a single node allocating 2 gigs of memory for a maximum of 2 hours.</p></li>
</ol>
</div>
<div id="nonos-when-using-r" class="section level2">
<h2>NoNos when using R</h2>
<ul>
<li><p>Do computation on the head node (compile stuff is OK)</p></li>
<li><p>Request a number of nodes (unless you know what you are doing)</p></li>
<li><p>Use your home directory for I/O</p></li>
<li><p>Save important information in Staging/Scratch</p></li>
</ul>
</div>




</div>

<script>

// add bootstrap table styles to pandoc tables
function bootstrapStylePandocTables() {
  $('tr.odd').parent('tbody').parent('table').addClass('table table-condensed');
}
$(document).ready(function () {
  bootstrapStylePandocTables();
});


</script>

<!-- tabsets -->

<script>
$(document).ready(function () {
  window.buildTabsets("TOC");
});

$(document).ready(function () {
  $('.tabset-dropdown > .nav-tabs > li').click(function () {
    $(this).parent().toggleClass('nav-tabs-open')
  });
});
</script>

<!-- code folding -->


<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
  (function () {
    var script = document.createElement("script");
    script.type = "text/javascript";
    script.src  = "https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-AMS-MML_HTMLorMML";
    document.getElementsByTagName("head")[0].appendChild(script);
  })();
</script>

</body>
</html>
